<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Penalty Tracking – ASV Natz</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0b1220;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--accent2:#22d3ee;--border:#1f2937}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:
  radial-gradient(1200px 600px at 20% -10%,#0f172a 10%,transparent 60%),
  radial-gradient(900px 500px at 120% 20%,#111827 10%,transparent 70%),
  var(--bg);color:var(--text);font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  display:flex;flex-direction:column}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:18px clamp(12px,3vw,28px);border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));position:sticky;top:0;z-index:10}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:42px;width:auto;border-radius:6px;background:#fff;padding:2px}
.brand h1{margin:0;font-size:clamp(20px,3vw,28px)}
.badge{font-weight:800;padding:4px 8px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1220}
main{padding:18px clamp(12px,3vw,28px);flex:1}
footer{padding:18px clamp(12px,3vw,28px);color:var(--muted);border-top:1px solid var(--border)}
.card{background:rgba(17,24,39,.65);border:1px solid var(--border);border-radius:16px;padding:16px;backdrop-filter:blur(6px);margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0b1220;color:#e5e7eb;outline:none}
.input:focus,select:focus{border-color:var(--accent)}
.btn{padding:10px 14px;border:0;border-radius:12px;cursor:pointer;font-weight:700}
.btn.primary{color:#0b1220;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.btn.secondary{background:#334155;color:#e5e7eb}
.btn.icon{display:inline-flex;align-items:center;gap:8px}
.btn.danger{background:linear-gradient(90deg,#fb7185,#f43f5e);color:#0b1220}
.btn.small{padding:6px 10px;font-size:13px;border-radius:10px}
.muted{color:var(--muted)} .roleTag{font-weight:800;color:var(--muted)}
.tabs{display:flex;gap:8px;margin:10px 0}
.tabs .t{padding:10px 12px;border-radius:12px;background:#0b1220;color:#cbd5e1;border:1px solid var(--border);cursor:pointer}
.tabs .t.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1220;border:0}
.hidden{display:none !important} .kpi{font-size:32px;font-weight:900}
.split{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:1200px){.split{grid-template-columns:1fr 1fr}}
@media(max-width:900px){.split{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left} th{color:#cbd5e1;font-weight:700}
.cfg details>summary{cursor:pointer;color:var(--muted)} .cfg-panel{margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
#errbar{position:fixed;right:12px;top:12px;background:#991b1b;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.3);display:none;z-index:9999;max-width:70vw}
.date-wrap{display:flex;gap:8px;align-items:center;min-width:240px}
.date-wrap .input{flex:1}
</style>
</head>
<body>
<div id="errbar"></div>

<header>
  <div class="brand">
    <img src="./logo_asv_natz.png" alt="ASV Natz Logo" id="brandLogo">
    <span class="badge">Penalty</span>
    <h1>Tracking – ASV Natz</h1>
  </div>
  <div class="cfg">
    <details>
      <summary>⚙️ Konfiguration</summary>
      <div class="cfg-panel card">
        <label>API URL (Apps Script /exec)<input id="apiUrl" class="input"></label>
        <label>API Key (alle)<input id="apiKey" class="input"></label>
        <label>Admin Key (nur Admin)<input id="adminKey" class="input"></label>
        <div class="row">
          <button id="saveCfg" class="btn primary">Speichern</button>
          <button id="clearCfg" class="btn secondary">Zurücksetzen</button>
          <span id="cfgMsg" class="muted"></span>
        </div>
      </div>
    </details>
  </div>
  <span id="roleTag" class="roleTag">Rolle: –</span>
</header>

<main>
  <section id="screenRole" class="card">
    <h2>Willkommen 👋</h2>
    <p class="muted">Zugang wählen</p>
    <div class="row">
      <div class="card" style="flex:1">
        <h3>👤 Spieler</h3>
        <p class="muted"></p>
        <button id="btnPlayer" class="btn primary">Als Spieler starten</button>
      </div>
      <div class="card" style="flex:1">
        <h3>🛡️ Admin</h3>
        <input id="adminPwd" class="input" type="password" placeholder="Admin-Passwort eingeben">
        <button id="btnAdmin" class="btn secondary">Als Admin anmelden</button>
        <span id="loginMsg" class="muted"></span>
      </div>
    </div>
  </section>

  <nav id="tabs" class="tabs hidden">
    <button class="t active" data-tab="tab1">1) Dashboard</button>
    <button class="t" data-tab="tab2">2) Strafen (Spieler)</button>
    <button class="t adminOnly" data-tab="tab3">3) Strafenerfassung</button>
    <button class="t adminOnly" data-tab="tab4">4) Stammdaten</button>
  </nav>

  <section id="tab1" class="card hidden">
    <div class="split">
      <div class="card"><h3>Pott (Summe €)</h3><div id="pott" class="kpi">0,00 €</div><p id="countSum" class="muted">– Einträge</p></div>
      <div class="card"><h3>Top 3 Spieler (Summe €)</h3><ol id="top3" style="margin:0;padding-left:22px"></ol></div>
      <div class="card">
        <h3>Top 3 (gefiltert nach Strafe)</h3>
        <label style="min-width:240px">Strafe wählen
          <select id="filterFineTop" class="input"></select>
        </label>
        <ol id="top3Fine" style="margin:10px 0 0 22px;"></ol>
      </div>
    </div>
    <div class="card" style="margin-top:12px"><h3>Akkumulierte Strafen über Zeit</h3><canvas id="chart" height="110"></canvas></div>
  </section>

  <section id="tab2" class="card hidden">
    <div class="row" style="align-items:flex-end">
      <label style="min-width:240px">Spieler wählen<select id="filterPlayer" class="input"></select></label>
      <span id="detailSum" class="kpi">0,00 €</span>
    </div>
    <div class="card" style="margin-top:12px;overflow:auto">
      <table><thead><tr><th>Datum</th><th>Spieler</th><th>Vergehen</th><th>Betrag (€)</th></tr></thead><tbody id="detailBody"></tbody></table>
    </div>
  </section>

  <section id="tab3" class="card hidden">
    <h3>Strafenerfassung (Admin)</h3>
    <div class="row">
      <label style="min-width:260px">Spieler (Mehrfachauswahl)<select id="entryPlayers" class="input" multiple size="8" style="height:220px"></select></label>
      <label style="min-width:260px">Strafe (aus Stammdaten)<select id="entryFine" class="input"></select></label>
      <div class="date-wrap">
        <label style="flex:1">Datum
          <input id="entryDate" class="input" type="date">
        </label>
        <button id="btnPickDate" class="btn secondary icon" title="Kalender öffnen">📅 Kalender</button>
      </div>
    </div>
    <div class="row"><button id="saveEntry" class="btn primary">➕ Speichern</button><span id="msgEntry" class="muted"></span></div>

    <div class="card" style="margin-top:14px;overflow:auto">
      <h4>Letzte Einträge</h4>
      <table>
        <thead><tr><th>Datum</th><th>Spieler</th><th>Vergehen</th><th>Betrag (€)</th></tr></thead>
        <tbody id="recentEntries"></tbody>
      </table>
    </div>
  </section>

  <section id="tab4" class="card hidden">
    <div class="split" style="grid-template-columns:1fr 1fr">
      <div class="card">
        <h3>Spielerliste</h3>
        <div class="row">
          <input id="playerName" class="input" placeholder="Neuer/zu ändernder Spielername">
          <button id="addPlayer" class="btn primary">Speichern / Upsert</button>
        </div>
        <div class="card" style="margin-top:12px;overflow:auto">
          <table><thead><tr><th>Spieler</th><th style="width:1%">Aktionen</th></tr></thead><tbody id="playersTable"></tbody></table>
        </div>
      </div>
      <div class="card">
        <h3>Strafenliste (Vergehen & Betrag €)</h3>
        <div class="row">
          <input id="fineName" class="input" placeholder="Vergehen">
          <input id="fineAmount" class="input" type="number" step="0.01" placeholder="Betrag (€)">
          <button id="addFine" class="btn primary">Speichern / Upsert</button>
        </div>
        <div class="card" style="margin-top:12px;overflow:auto">
          <table><thead><tr><th>Vergehen</th><th>Betrag (€)</th><th style="width:1%">Aktionen</th></tr></thead><tbody id="finesTable"></tbody></table>
        </div>
      </div>
    </div>
  </section>
</main>

<footer><span class="muted">© Penalty Tracking – ASV Natz • statische App • Google Sheets (Apps Script)</span></footer>

<script>
/* === Fehler-Banner === */
function showErr(msg){const b=document.getElementById('errbar');b.textContent=msg;b.style.display='block';console.error('[PenaltyTrack]',msg);}
window.onerror=(m)=>{showErr(String(m));};

/* === Utils === */
const $=id=>document.getElementById(id);
const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));
const euro=n=>(Number(n)||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'});
const num=v=>{if(v==null) return 0; const s=String(v).replace(/\./g,'.').replace(',','.'); const x=parseFloat(s); return Number.isFinite(x)?x:0}
function ymd(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;}

/* === Variante A: feste Defaults (öffentlich sichtbar!) === */
const DEFAULTS = {
  API: 'https://script.google.com/macros/s/AKfycbwuK_OfA5oKJUdypJ0ZhdrabDsxcx4kIHXe0NVzp2gtgajX-RRy958UORCITdaVSzYlvw/exec',    // <- hier /exec URL eintragen
  KEY: '2f1e7b4a9c6d48f8a0d1f3c27e6a9b52',
  ADM: '9e3c0a7f2d584c86b1a44e2f7d9b6f01'
};
const LOCK_CONFIG = true;

/* === Config & Role === */
const LS={api:'pt_api',key:'pt_key',adm:'pt_adm',role:'pt_role'};
const ADMIN_PWD='admin2024';

function updateRoleTag(){
  const role=localStorage.getItem(LS.role)||'–';
  $('roleTag').textContent='Rolle: '+role;
  const isAdmin=(role==='Admin');
  qsa('.adminOnly').forEach(el=>el.classList.toggle('hidden',!isAdmin));
}
function loadCfg(){
  const api = localStorage.getItem(LS.api) || DEFAULTS.API;
  const key = localStorage.getItem(LS.key) || DEFAULTS.KEY;
  const adm = localStorage.getItem(LS.adm) || DEFAULTS.ADM;
  $('apiUrl').value=api; $('apiKey').value=key; $('adminKey').value=adm;
  updateRoleTag();
  if(LOCK_CONFIG){
    document.querySelector('.cfg details').open=false;
    qsa('.cfg input, .cfg button').forEach(el=>el.disabled=true);
  }
}
function saveCfg(){ if(LOCK_CONFIG) return; }
function clearCfg(){ if(LOCK_CONFIG) return; }

document.addEventListener('DOMContentLoaded',()=>{
  $('btnPlayer').onclick=()=>{localStorage.setItem(LS.role,'Spieler');updateRoleTag();showApp();};
  $('btnAdmin').onclick=()=>{const p=$('adminPwd').value.trim(); if(p!==ADMIN_PWD){$('loginMsg').textContent='Falsches Passwort';return;} $('loginMsg').textContent='';localStorage.setItem(LS.role,'Admin');updateRoleTag();showApp();};

  const date=$('entryDate'), btn=$('btnPickDate');
  if(date){
    const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    date.value=`${yyyy}-${mm}-${dd}`;
    const openPicker=()=>{ if(typeof date.showPicker==='function'){ date.showPicker(); } else { date.focus(); date.click(); } };
    date.addEventListener('focus', openPicker); btn.addEventListener('click', openPicker);
  }

  qsa('#tabs .t').forEach(b=>b.onclick=()=>switchTab(b.dataset.tab));
  loadCfg();
});

/* === UI === */
function showApp(){ $('screenRole').classList.add('hidden'); $('tabs').classList.remove('hidden'); switchTab('tab1'); }
function switchTab(id){
  qsa('main section').forEach(s=>s.classList.add('hidden'));
  $('tabs').classList.remove('hidden');
  qsa('#tabs .t').forEach(b=>b.classList.toggle('active',b.dataset.tab===id));
  const sec=$(id); if(!sec){showErr('Tab nicht gefunden: '+id);return;}
  sec.classList.remove('hidden');
  if(id==='tab1') refreshDashboard();
  if(id==='tab2') refreshDetail();
  if(id==='tab3'){ loadEntryMeta(); refreshRecentEntries(); }
  if(id==='tab4') refreshMetaTables();
}

/* === API === */
function cfg(){
  const api=(localStorage.getItem(LS.api)||DEFAULTS.API).trim();
  const key=(localStorage.getItem(LS.key)||DEFAULTS.KEY).trim();
  const adm=(localStorage.getItem(LS.adm)||DEFAULTS.ADM).trim();
  if(!api||!key){showErr('API-URL/Key fehlen.');throw new Error('Config fehlt');}
  return {api,key,adm};
}
async function apiGet(params={}){
  try{
    const {api,key}=cfg(); const u=new URL(api); u.searchParams.set('apiKey',key);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
    const r=await fetch(u.toString(),{cache:'no-store'});
    if(!r.ok) throw new Error('GET '+r.status);
    return r.json();
  }catch(err){showErr('Fetch fehlgeschlagen: '+(err.message||err));throw err;}
}
async function apiPost(body){
  const {api,key}=cfg();
  const r=await fetch(api,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({apiKey:key,...body})});
  if(!r.ok) throw new Error('POST '+r.status);
  return r.json();
}
async function apiAdmin(action,body){
  const {api,key,adm}=cfg();
  const r=await fetch(api+'?action='+encodeURIComponent(action),{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({apiKey:key,adminKey:adm,...body})});
  if(!r.ok) throw new Error(action+' '+r.status);
  return r.json();
}

/* === Tab 1: Dashboard mit täglicher X-Achse === */
function computeTop3ByFine(rows,fineName){
  const per={}; rows.filter(r=>(r.fine||'')===fineName).forEach(r=>{ const k=r.name||''; per[k]=(per[k]||0)+num(r.amount); });
  return Object.entries(per).sort((a,b)=>b[1]-a[1]).slice(0,3);
}
let lineChart=null;
async function refreshDashboard(){
  try{
    const data=await apiGet({view:'all'});
    if(!data.ok) throw new Error(data.error||'API');
    const rows=(data.rows||[]).map(r=>({...r,amount:num(r.amount)}));
    const fines=(data.fines||[]);

    $('countSum').textContent=rows.length+' Einträge';
    const total=rows.reduce((a,r)=>a+num(r.amount),0); $('pott').textContent=euro(total);

    const per={}; rows.forEach(r=>{const k=r.name||''; per[k]=(per[k]||0)+num(r.amount);});
    const top=Object.entries(per).sort((a,b)=>b[1]-a[1]).slice(0,3);
    const ol=$('top3'); ol.innerHTML=''; top.forEach(([n,amt])=>{const li=document.createElement('li'); li.textContent=`${n}: ${amt.toFixed(2)} €`; ol.appendChild(li);});

    // Tägliche Zeitskala, kumuliert
    const ctx=$('chart').getContext('2d'); if(lineChart) lineChart.destroy();
    if(rows.length){
      const ts=rows.map(r=>new Date(r.ts||Date.now())).sort((a,b)=>a-b);
      const start=new Date(ymd(ts[0])+'T00:00:00'); const end=new Date(ymd(ts[ts.length-1])+'T00:00:00');
      const perDay=new Map(); rows.forEach(r=>{const k=ymd(new Date(r.ts)); perDay.set(k,(perDay.get(k)||0)+num(r.amount));});
      const labels=[],vals=[]; let run=0;
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){ const k=ymd(d); run+=(perDay.get(k)||0); labels.push(d.toLocaleDateString('de-DE')); vals.push(run); }
      lineChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Akkumuliert (€) – täglich',data:vals,tension:.25}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
    }else{
      lineChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Akkumuliert (€) – täglich',data:[]}]},options:{responsive:true}});
    }

    const sel=$('filterFineTop');
    if (sel && !sel.dataset.filled) {
      sel.innerHTML='';
      fines.forEach(f=>{ const o=document.createElement('option'); o.value=f.name; o.textContent=`${f.name} (${num(f.amount).toFixed(2)} €)`; sel.appendChild(o); });
      sel.dataset.filled='1';
      sel.onchange=()=>updateTop3Fine(rows, sel.value);
    }
    if (sel && sel.value) updateTop3Fine(rows, sel.value);

  }catch(e){ showErr(String(e.message||e)); }
}
function updateTop3Fine(rows,fineName){
  const list=$('top3Fine'); list.innerHTML='';
  const top=computeTop3ByFine(rows,fineName);
  if(top.length===0){ const li=document.createElement('li'); li.textContent='Keine Einträge'; list.appendChild(li); return; }
  top.forEach(([n,amt])=>{ const li=document.createElement('li'); li.textContent=`${n}: ${amt.toFixed(2)} €`; list.appendChild(li); });
}

/* === Tab 2: Detail === */
async function refreshDetail(){
  try{
    const data=await apiGet({view:'all'}); if(!data.ok) throw new Error(data.error||'API');
    const players=data.players||[]; const rows=(data.rows||[]).map(r=>({...r,amount:num(r.amount)}));
    const sel=$('filterPlayer'); sel.innerHTML='';
    players.forEach(p=>{const o=document.createElement('option'); o.value=p.name; o.textContent=p.name; sel.appendChild(o);});
    sel.onchange=()=>fillDetail(rows,sel.value);
    if(players[0]) fillDetail(rows,players[0].name); else{$('detailBody').innerHTML='';$('detailSum').textContent=euro(0);}
  }catch(e){showErr(String(e.message||e));}
}
function fillDetail(rows,name){
  const body=$('detailBody'); body.innerHTML=''; let sum=0;
  rows.filter(r=>(r.name||'')===name).sort((a,b)=>String(b.ts).localeCompare(String(a.ts))).forEach(r=>{
    sum+=num(r.amount); const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(r.ts).toLocaleDateString()}</td><td>${r.name}</td><td>${r.fine||''}</td><td>${num(r.amount).toFixed(2)}</td>`;
    body.appendChild(tr);
  });
  $('detailSum').textContent=euro(sum);
}

/* === Tab 3: Erfassung === */
let FINES_MAP=new Map();
async function loadEntryMeta(){
  if((localStorage.getItem(LS.role)||'')!=='Admin') return;
  try{
    const meta=await apiGet({view:'meta'}); if(!meta.ok) throw new Error(meta.error||'API');
    const players=meta.players||[], fines=meta.fines||[];
    FINES_MAP = new Map(fines.map(f=>[f.name, num(f.amount)]));
    const selP=$('entryPlayers'); selP.innerHTML=''; players.forEach(p=>{const o=document.createElement('option'); o.value=p.name; o.textContent=p.name; selP.appendChild(o);});
    const selF=$('entryFine'); selF.innerHTML=''; fines.forEach(f=>{const o=document.createElement('option'); o.value=f.name; o.textContent=`${f.name} (${num(f.amount).toFixed(2)} €)`; o.dataset.amount=num(f.amount); selF.appendChild(o);});
  }catch(e){showErr(String(e.message||e));}
}
$('saveEntry')?.addEventListener('click', async ()=>{
  try{
    const selP=$('entryPlayers'), selF=$('entryFine');
    const names=[...selP.selectedOptions].map(o=>o.value);
    const opt=selF.selectedOptions[0]; const fine=opt?opt.value:''; 
    const amount=opt?num(opt.dataset.amount): (FINES_MAP.has(fine)?FINES_MAP.get(fine):0);
    const dateStr=$('entryDate').value; if(!dateStr){alert('Bitte Datum wählen');return;}
    const ts=new Date(dateStr+'T00:00:00').toISOString();
    if(!names.length||!fine){alert('Bitte Spieler & Strafe wählen');return;}
    for(const n of names){ await apiPost({name:n,fine,amount,ts}); }
    $('msgEntry').textContent='Gespeichert ✔'; setTimeout(()=>{$('msgEntry').textContent='';},1200);
    await refreshDashboard(); await refreshDetail(); await refreshRecentEntries();
  }catch(err){showErr(String(err.message||err));}
});

/* Letzte Einträge + Löschen */
async function refreshRecentEntries(){
  try{
    const data=await apiGet({view:'all'}); if(!data.ok) throw new Error(data.error||'API');
    const rows=(data.rows||[]).map(r=>({...r,amount:num(r.amount)}))
      .sort((a,b)=>String(b.ts).localeCompare(String(a.ts))).slice(0,50);
    const tb=$('recentEntries'); tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const d=new Date(r.ts).toLocaleDateString('de-DE');
      tr.innerHTML=`<td>${d}</td><td>${r.name||''}</td><td>${r.fine||''}</td>
        <td style="white-space:nowrap">${num(r.amount).toFixed(2)}
        ${(localStorage.getItem(LS.role)==='Admin' && r.id) ? `&nbsp;<button class="btn danger small del" data-id="${r.id}">Löschen</button>` : ''}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){showErr(String(e.message||e));}
}
$('recentEntries').addEventListener('click', async (ev)=>{
  const btn=ev.target.closest('button.del'); if(!btn) return;
  const id=btn.dataset.id; if(!id) return;
  if(!confirm('Diesen Eintrag wirklich löschen?')) return;
  try{
    await apiAdmin('delete_entry',{id});
    await refreshDashboard(); await refreshDetail(); await refreshRecentEntries();
  }catch(err){showErr('Löschen fehlgeschlagen: '+(err.message||err));}
});

/* === Tab 4: Stammdaten === */
async function refreshMetaTables(){
  if((localStorage.getItem(LS.role)||'')!=='Admin') return;
  try{
    const meta=await apiGet({view:'meta'}); if(!meta.ok) throw new Error(meta.error||'API');
    drawPlayersTable(meta.players||[]); drawFinesTable(meta.fines||[]);
    $('addPlayer').onclick=async()=>{
      const name=$('playerName').value.trim(); if(!name){alert('Name?');return;}
      await apiAdmin('upsert_player',{name}); $('playerName').value='';
      await refreshMetaTables(); await loadEntryMeta();
    };
    $('addFine').onclick=async()=>{
      const name=$('fineName').value.trim(); const amount=num($('fineAmount').value);
      if(!name||!Number.isFinite(amount)){alert('Vergehen & Betrag?');return;}
      await apiAdmin('upsert_fine',{name,amount}); $('fineName').value=''; $('fineAmount').value='';
      await refreshMetaTables(); await loadEntryMeta();
    };
  }catch(e){showErr(String(e.message||e));}
}
function drawPlayersTable(list){
  const tb=$('playersTable'); tb.innerHTML='';
  list.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td><button class="btn danger small" data-del-player="${p.name}">Löschen</button></td>`;
    tr.querySelector('[data-del-player]').onclick=async()=>{
      if(!confirm('Spieler löschen: '+p.name+'?')) return;
      await apiAdmin('delete_player',{name:p.name}); await refreshMetaTables(); await loadEntryMeta();
    };
    tb.appendChild(tr);
  });
}
function drawFinesTable(list){
  const tb=$('finesTable'); tb.innerHTML='';
  list.sort((a,b)=>a.name.localeCompare(b.name)).forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.name}</td><td>${num(f.amount).toFixed(2)}</td><td><button class="btn danger small" data-del-fine="${f.name}">Löschen</button></td>`;
    tr.querySelector('[data-del-fine]').onclick=async()=>{
      if(!confirm('Strafe löschen: '+f.name+'?')) return;
      await apiAdmin('delete_fine',{name:f.name}); await refreshMetaTables(); await loadEntryMeta();
    };
    tb.appendChild(tr);
  });
}

/* === Init === */
loadCfg();
</script>
</body>
</html>
